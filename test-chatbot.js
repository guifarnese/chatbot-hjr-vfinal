const SimpleChatbot = require('./app/chatbot-simple.js');

class ChatbotTester {
    constructor() {
        this.chatbot = new SimpleChatbot();
        this.testResults = [];
        this.currentTest = null;
    }

    // Simular cliente WhatsApp
    async simulateClient(whatsappNumber, message) {
        console.log(`\nüì± [${whatsappNumber}] Cliente: "${message}"`);

        try {
            const response = await this.chatbot.processMessage(whatsappNumber, message);
            console.log(`ü§ñ [BOT] Resposta: "${response}"`);
            return response;
        } catch (error) {
            console.error(`‚ùå Erro: ${error.message}`);
            return null;
        }
    }

    // Simular humano WhatsApp
    async simulateHuman(whatsappNumber, message) {
        console.log(`\nüë§ [HUMANO] ${whatsappNumber}: "${message}"`);

        try {
            const response = await this.chatbot.processMessage(whatsappNumber, message);
            console.log(`ü§ñ [BOT] Resposta: "${response}"`);
            return response;
        } catch (error) {
            console.error(`‚ùå Erro: ${error.message}`);
            return null;
        }
    }

    // Aguardar um tempo (simular delay real)
    async delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Teste 1: Fluxo completo de solicita√ß√£o de pe√ßas
    async testPartsFlow() {
        console.log('\nüß™ ===== TESTE 1: FLUXO DE SOLICITA√á√ÉO DE PE√áAS =====');
        this.currentTest = 'Parts Flow';

        const clientNumber = '+5511999999999';

        try {
            // 1. Iniciar conversa
            await this.simulateClient(clientNumber, 'Oi');
            await this.delay(1000);

            // 2. Informar nome
            await this.simulateClient(clientNumber, 'Jo√£o Silva');
            await this.delay(1000);

            // 3. Informar endere√ßo
            await this.simulateClient(clientNumber, 'Fazenda S√£o Jos√©, Zona Rural, Uberaba-MG');
            await this.delay(1000);

            // 4. Escolher pe√ßas
            await this.simulateClient(clientNumber, '1');
            await this.delay(1000);

            // 5. Informar detalhes da pe√ßa
            await this.simulateClient(clientNumber, 'Tenho um compressor Bitzer que a v√°lvula de descarga t√° com problema');
            await this.delay(1000);

            // 6. Tentar enviar foto (simular que n√£o consegue)
            await this.simulateClient(clientNumber, 'N√£o consigo tirar foto agora');
            await this.delay(1000);

            // 7. Descrever defeito
            await this.simulateClient(clientNumber, 'O compressor t√° fazendo muito barulho e n√£o t√° gelando direito. Come√ßou h√° uns 3 dias');
            await this.delay(1000);

            // 8. Escolher finalizar
            await this.simulateClient(clientNumber, '3');

            this.testResults.push({
                test: 'Parts Flow',
                status: 'PASSED',
                description: 'Fluxo completo de solicita√ß√£o de pe√ßas executado com sucesso'
            });

        } catch (error) {
            this.testResults.push({
                test: 'Parts Flow',
                status: 'FAILED',
                description: `Erro: ${error.message}`
            });
        }
    }

    // Teste 2: Fluxo de problema/defeito
    async testProblemFlow() {
        console.log('\nüß™ ===== TESTE 2: FLUXO DE PROBLEMA/DEFEITO =====');
        this.currentTest = 'Problem Flow';

        const clientNumber = '+5511888888888';

        try {
            // 1. Iniciar conversa
            await this.simulateClient(clientNumber, 'Ol√°');
            await this.delay(1000);

            // 2. Informar nome
            await this.simulateClient(clientNumber, 'Maria Santos');
            await this.delay(1000);

            // 3. Informar endere√ßo
            await this.simulateClient(clientNumber, 'S√≠tio Boa Vista, Zona Rural, Patos de Minas-MG');
            await this.delay(1000);

            // 4. Escolher problema/defeito
            await this.simulateClient(clientNumber, '2');
            await this.delay(1000);

            // 5. Descrever problema
            await this.simulateClient(clientNumber, 'Meu freezer n√£o est√° gelando mais');
            await this.delay(2000); // Simular delay da IA

            // 6. Responder perguntas de follow-up (simular algumas)
            await this.simulateClient(clientNumber, 'Come√ßou ontem');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'N√£o faz barulho diferente');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'N√£o tentei nada ainda');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'Acontece sempre');
            await this.delay(2000); // Simular an√°lise da IA

            // 7. Escolher transferir para humano
            await this.simulateClient(clientNumber, '2');

            this.testResults.push({
                test: 'Problem Flow',
                status: 'PASSED',
                description: 'Fluxo completo de problema/defeito executado com sucesso'
            });

        } catch (error) {
            this.testResults.push({
                test: 'Problem Flow',
                status: 'FAILED',
                description: `Erro: ${error.message}`
            });
        }
    }

    // Teste 3: Fluxo de revis√£o
    async testReviewFlow() {
        console.log('\nüß™ ===== TESTE 3: FLUXO DE REVIS√ÉO =====');
        this.currentTest = 'Review Flow';

        const clientNumber = '+5511777777777';

        try {
            // 1. Iniciar conversa
            await this.simulateClient(clientNumber, 'Boa tarde');
            await this.delay(1000);

            // 2. Informar nome
            await this.simulateClient(clientNumber, 'Pedro Oliveira');
            await this.delay(1000);

            // 3. Informar endere√ßo
            await this.simulateClient(clientNumber, 'Fazenda Esperan√ßa, Zona Rural, Arax√°-MG');
            await this.delay(1000);

            // 4. Escolher revis√£o
            await this.simulateClient(clientNumber, '3');
            await this.delay(1000);

            // 5. Informar equipamento
            await this.simulateClient(clientNumber, 'Ar condicionado central Carrier');
            await this.delay(1000);

            // 6. Escolher ligar para escrit√≥rio
            await this.simulateClient(clientNumber, '1');

            this.testResults.push({
                test: 'Review Flow',
                status: 'PASSED',
                description: 'Fluxo completo de revis√£o executado com sucesso'
            });

        } catch (error) {
            this.testResults.push({
                test: 'Review Flow',
                status: 'FAILED',
                description: `Erro: ${error.message}`
            });
        }
    }

    // Teste 4: Transfer√™ncia para humano
    async testHumanTransfer() {
        console.log('\nüß™ ===== TESTE 4: TRANSFER√äNCIA PARA HUMANO =====');
        this.currentTest = 'Human Transfer';

        const clientNumber = '+5511666666666';
        const humanNumber = '31999917243';

        try {
            // 1. Iniciar conversa e ir at√© transfer√™ncia
            await this.simulateClient(clientNumber, 'Oi');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'Carlos Mendes');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'Fazenda Nova, Zona Rural, Uberl√¢ndia-MG');
            await this.delay(1000);

            await this.simulateClient(clientNumber, '2'); // Problema/defeito
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'Meu ar condicionado n√£o est√° funcionando');
            await this.delay(2000);

            // Simular algumas respostas r√°pidas
            await this.simulateClient(clientNumber, 'Ontem');
            await this.delay(1000);
            await this.simulateClient(clientNumber, 'Sim, faz barulho');
            await this.delay(1000);
            await this.simulateClient(clientNumber, 'N√£o tentei');
            await this.delay(1000);
            await this.simulateClient(clientNumber, 'Sempre');
            await this.delay(2000);

            await this.simulateClient(clientNumber, '2'); // Transferir para humano
            await this.delay(1000);

            // 2. Simular mensagem do cliente para humano
            await this.simulateClient(clientNumber, 'Preciso de mais informa√ß√µes sobre o or√ßamento');
            await this.delay(1000);

            // 3. Simular resposta do humano
            await this.simulateHuman(humanNumber, 'Ol√° Carlos! Posso te ajudar com o or√ßamento. Qual √© sua d√∫vida espec√≠fica?');
            await this.delay(1000);

            // 4. Simular comando do humano para encerrar
            await this.simulateHuman(humanNumber, '/encerrar');

            this.testResults.push({
                test: 'Human Transfer',
                status: 'PASSED',
                description: 'Fluxo completo de transfer√™ncia para humano executado com sucesso'
            });

        } catch (error) {
            this.testResults.push({
                test: 'Human Transfer',
                status: 'FAILED',
                description: `Erro: ${error.message}`
            });
        }
    }

    // Teste 5: Sistema de follow-up
    async testFollowupSystem() {
        console.log('\nüß™ ===== TESTE 5: SISTEMA DE FOLLOW-UP =====');
        this.currentTest = 'Followup System';

        const clientNumber = '+5511555555555';

        try {
            // 1. Iniciar conversa e parar no meio
            await this.simulateClient(clientNumber, 'Oi');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'Ana Costa');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'Fazenda Sol, Zona Rural, Patroc√≠nio-MG');
            await this.delay(1000);

            // 2. Escolher pe√ßas e parar
            await this.simulateClient(clientNumber, '1');
            await this.delay(1000);

            // 3. Simular que o usu√°rio n√£o responde (n√£o enviar mais mensagens)
            console.log('‚è∞ Simulando inatividade de 3 horas...');
            console.log('üí° Em um cen√°rio real, o sistema enviaria follow-up ap√≥s 3h');

            // 4. Simular resposta ao follow-up
            console.log('üìû Simulando follow-up recebido:');
            await this.simulateClient(clientNumber, '1'); // Continuar atendimento
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'Compressor Copeland com problema na v√°lvula');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'N√£o tenho foto');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'Est√° vazando g√°s');
            await this.delay(1000);

            await this.simulateClient(clientNumber, '3'); // Finalizar

            this.testResults.push({
                test: 'Followup System',
                status: 'PASSED',
                description: 'Sistema de follow-up testado com sucesso'
            });

        } catch (error) {
            this.testResults.push({
                test: 'Followup System',
                status: 'FAILED',
                description: `Erro: ${error.message}`
            });
        }
    }

    // Teste 6: Casos de erro e edge cases
    async testErrorCases() {
        console.log('\nüß™ ===== TESTE 6: CASOS DE ERRO E EDGE CASES =====');
        this.currentTest = 'Error Cases';

        const clientNumber = '+5511444444444';

        try {
            // 1. Testar op√ß√£o inv√°lida no menu
            await this.simulateClient(clientNumber, 'Oi');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'Teste Erro');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'Endere√ßo teste');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'op√ß√£o inv√°lida');
            await this.delay(1000);

            // 2. Testar op√ß√£o v√°lida ap√≥s erro
            await this.simulateClient(clientNumber, '1');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'Equipamento teste');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'N√£o tenho foto');
            await this.delay(1000);

            await this.simulateClient(clientNumber, 'Defeito teste');
            await this.delay(1000);

            await this.simulateClient(clientNumber, '3');

            this.testResults.push({
                test: 'Error Cases',
                status: 'PASSED',
                description: 'Casos de erro tratados corretamente'
            });

        } catch (error) {
            this.testResults.push({
                test: 'Error Cases',
                status: 'FAILED',
                description: `Erro: ${error.message}`
            });
        }
    }

    // Executar todos os testes
    async runAllTests() {
        console.log('üöÄ INICIANDO TESTES DO CHATBOT REFRIAGRO');
        console.log('==========================================');

        const startTime = Date.now();

        try {
            await this.testPartsFlow();
            await this.delay(2000);

            await this.testProblemFlow();
            await this.delay(2000);

            await this.testReviewFlow();
            await this.delay(2000);

            await this.testHumanTransfer();
            await this.delay(2000);

            await this.testFollowupSystem();
            await this.delay(2000);

            await this.testErrorCases();

        } catch (error) {
            console.error('‚ùå Erro durante execu√ß√£o dos testes:', error.message);
        }

        const endTime = Date.now();
        const duration = (endTime - startTime) / 1000;

        // Relat√≥rio final
        this.generateReport(duration);
    }

    // Gerar relat√≥rio de testes
    generateReport(duration) {
        console.log('\nüìä ===== RELAT√ìRIO DE TESTES =====');
        console.log(`‚è±Ô∏è  Dura√ß√£o total: ${duration.toFixed(2)} segundos`);
        console.log(`üß™ Total de testes: ${this.testResults.length}`);

        const passed = this.testResults.filter(t => t.status === 'PASSED').length;
        const failed = this.testResults.filter(t => t.status === 'FAILED').length;

        console.log(`‚úÖ Passou: ${passed}`);
        console.log(`‚ùå Falhou: ${failed}`);
        console.log(`üìà Taxa de sucesso: ${((passed / this.testResults.length) * 100).toFixed(1)}%`);

        console.log('\nüìã DETALHES DOS TESTES:');
        this.testResults.forEach((result, index) => {
            const status = result.status === 'PASSED' ? '‚úÖ' : '‚ùå';
            console.log(`${index + 1}. ${status} ${result.test}: ${result.description}`);
        });

        console.log('\nüéØ RESUMO:');
        if (failed === 0) {
            console.log('üéâ Todos os testes passaram! O chatbot est√° funcionando perfeitamente.');
        } else {
            console.log(`‚ö†Ô∏è  ${failed} teste(s) falharam. Verifique os logs acima para detalhes.`);
        }

        console.log('\nüí° PR√ìXIMOS PASSOS:');
        console.log('1. Verifique se todos os fluxos est√£o funcionando conforme esperado');
        console.log('2. Teste com usu√°rios reais em ambiente de desenvolvimento');
        console.log('3. Monitore logs em produ√ß√£o para identificar problemas');
        console.log('4. Ajuste mensagens baseado no feedback dos usu√°rios');
    }
}

// Executar testes se o arquivo for chamado diretamente
if (require.main === module) {
    const tester = new ChatbotTester();
    tester.runAllTests().catch(console.error);
}

module.exports = ChatbotTester;
